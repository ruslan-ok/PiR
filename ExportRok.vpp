//------------------------------------------------------------------------------
//                                                      (c) Корпорация Галактика
// Заработная плата по отделу
// Экспорт в rok
//------------------------------------------------------------------------------

File fRok;

private procedure DoExportRok;
{
  fRok.OpenFile(sResFile, stCreate);
//  fRok.WriteLn('<rok:Wage xmlns:rok="http://178.172.132.68/pir/">');
//  fRok.WriteLine('<rok:Periods>');

  mtPeriods.SetStream(fRok.Handle);
  mtDepart.SetStream(fRok.Handle);
  mtDepHist.SetStream(fRok.Handle);
  mtPost.SetStream(fRok.Handle);
  mtPayTitle.SetStream(fRok.Handle);
  mtPerson.SetStream(fRok.Handle);
  mtAppoint.SetStream(fRok.Handle);
  mtPersPer.SetStream(fRok.Handle);
  mtDebtIn.SetStream(fRok.Handle);
  mtNachisl.SetStream(fRok.Handle);
  mtPayment.SetStream(fRok.Handle);
  mtDebtOut.SetStream(fRok.Handle);

  mtPeriods.Start;
  _loop backward mtPeriods
    mtPeriods.Save;
  mtPeriods.Stop;

  ResetBounds(#mtDepart);
  mtDepart.Start;
  _loop mtDepart
    mtDepart.Save;
  mtDepart.Stop;
  SetBounds(#mtDepart);

  mtDepHist.Start;
  _loop mtDepHist
    mtDepHist.Save;
  mtDepHist.Stop;

  ResetBounds(#mtPost);
  mtPost.Start;
  _loop mtPost
    mtPost.Save;
  mtPost.Stop;
  SetBounds(#mtPost);

  mtPayTitle.Start;
  _loop mtPayTitle
    mtPayTitle.Save;
  mtPayTitle.Stop;

  mtPerson.Start;
  _loop mtPerson
  {
    mtPerson.Save;

    mtAppoint.Start;
    _loop mtAppoint where (( mtPerson.Id == mtAppoint.Person ))
      mtAppoint.Save;
    mtAppoint.Stop;

    mtPersPer.Start;
    _loop mtPersPer where (( mtPerson.Id == mtPersPer.Person ))
    {
      mtPersPer.Save;

      mtDebtIn.Start;
      if (GetFirst mtDebtIn where (( mtPersPer.Person == mtDebtIn.Person and
                                     mtPersPer.Period == mtDebtIn.Period )) = tsOk)
        mtDebtIn.Save;
      mtDebtIn.Stop;

      mtNachisl.Start;
      _loop mtNachisl where (( mtPersPer.Person == mtNachisl.Person and
                               mtPersPer.Period == mtNachisl.Period ))
        mtNachisl.Save;
      mtNachisl.Stop;

      mtPayment.Start;
      _loop mtPayment where (( mtPersPer.Person == mtPayment.Person and
                               mtPersPer.Period == mtPayment.Period ))
        mtPayment.Save;
      mtPayment.Stop;

      mtDebtOut.Start;
      if (GetFirst mtDebtOut where (( mtPersPer.Person == mtDebtOut.Person and
                                      mtPersPer.Period == mtDebtOut.Period )) = tsOk)
        mtDebtOut.Save;
      mtDebtOut.Stop;
    }
    mtPersPer.Stop;
  }
  mtPerson.Stop;

  fRok.Close;
  StopVisual;
}
